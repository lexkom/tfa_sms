# TFA SMS Module

Модуль для Drupal, который добавляет двухфакторную аутентификацию через SMS с использованием SMS Framework.

## Описание

Модуль `tfa_sms` предоставляет плагин для модуля TFA (Two-Factor Authentication), который позволяет пользователям получать коды подтверждения через SMS. Модуль использует SMS Framework для отправки сообщений и поддерживает различные SMS-провайдеры (например, Twilio).

## Требования

- Drupal 9/10/11
- Модуль [TFA](https://www.drupal.org/project/tfa)
- Модуль [SMS Framework](https://www.drupal.org/project/sms)
- Настроенный SMS-провайдер (например, Twilio)

## Установка

1. Установите модуль через Composer:
   ```bash
   composer require drupal/tfa_sms
   ```

2. Включите модуль через административный интерфейс или Drush:
   ```bash
   drush en tfa_sms
   ```

3. Настройте SMS-провайдер в SMS Framework (например, Twilio).

4. Перейдите в настройки TFA (`/admin/config/people/tfa`) и включите плагин "SMS TFA".

## Настройка

### Настройка модуля

1. Перейдите в настройки модуля (`/admin/config/people/tfa-sms`).
2. Укажите имя отправителя SMS.
3. Настройте префикс номера телефона (например, +1 для США).
4. При необходимости включите режим отладки.

### Поле телефона

Модуль автоматически создает поле `field_phone_number` для пользователей, если оно еще не существует. Если у вас уже установлен SMS Framework, модуль будет использовать его поле телефона.

Чтобы добавить поле телефона вручную:

1. Перейдите в настройки полей пользователя (`/admin/config/people/accounts/fields`).
2. Добавьте новое поле типа "Телефон".
3. Назовите поле `field_phone_number`.
4. Настройте видимость и доступность поля в форме редактирования профиля.

## Отладка

### Включение режима отладки

1. Перейдите в настройки модуля (`/admin/config/people/tfa-sms`).
2. Включите опцию "Enable debug logging".

### Просмотр логов

В режиме отладки модуль записывает подробные логи в канал `tfa_sms_gateway`. Вы можете просмотреть логи:

1. Через административный интерфейс: `/admin/reports/dblog`
2. Через Drush:
   ```bash
   drush ws --type=tfa_sms_gateway
   ```

### Тестирование отправки SMS

В настройках модуля есть раздел "Test SMS sending", где вы можете:

1. Ввести тестовый номер телефона
2. Ввести тестовое сообщение
3. Отправить тестовое SMS

В режиме отладки SMS не будут отправляться реально, а только логироваться.

## Ограничения

- Максимальное количество попыток ввода кода: 3
- Код действителен только для одной попытки входа
- Требуется действительный номер телефона у пользователя

## Безопасность

- Коды генерируются с использованием криптографически безопасного генератора случайных чисел
- Все попытки входа логируются
- Поддерживается ограничение количества попыток
- Номера телефонов проверяются на валидность

## Поддержка

Если у вас возникли проблемы или есть предложения по улучшению модуля, создайте issue в системе отслеживания проблем проекта. 